{% extends "base.html" %}
{% load static wagtailcore_tags %}

{% block title %}{{ page.title }}{% endblock %}

{% block body_class %}template-peptide-links{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/peptide_links.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    {# Page Header #}
    <div class="peptide-links-header mb-4">
        <h1 class="page-top-header">{{ page.title }}</h1>
        {% if page.intro %}
        <div class="row intro-columns">
            <div class="col-lg-6">
                <p>{{ intro_paragraph_1 }}</p>
            </div>
            <div class="col-lg-6">
                <p>{{ intro_paragraph_2 }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        {# Sidebar Filters #}
        <div class="col-12 col-lg-3 mb-4">
            <div class="filter-sidebar">
                {# Search #}
                <div class="filter-section">
                    <h6 class="filter-title">Search</h6>
                    <form method="get" class="search-form">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Name, institution..."
                                   value="{{ current_search }}">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        {# Preserve other filters #}
                        {% if current_country %}<input type="hidden" name="country" value="{{ current_country }}">{% endif %}
                        {% if current_state %}<input type="hidden" name="state" value="{{ current_state }}">{% endif %}
                    </form>
                </div>

                {# Browse by State #}
                <div class="filter-section">
                    <h6 class="filter-title">Browse by State â€“ USA</h6>
                    <div class="state-filter">
                        <a href="?{% if current_country %}country={{ current_country }}&{% endif %}{% if current_search %}q={{ current_search }}{% endif %}"
                           class="state-btn {% if not current_state %}active{% endif %}">All</a>
                        {% for state in states %}
                        <a href="?state={{ state }}&country=USA{% if current_search %}&q={{ current_search }}{% endif %}"
                           class="state-btn {% if current_state == state %}active{% endif %}">{{ state }}</a>
                        {% endfor %}
                    </div>
                </div>

                {# Country Filter #}
                <div class="filter-section">
                    <h6 class="filter-title">Country</h6>
                    <select class="form-select filter-select" id="countryFilter">
                        <option value="">All Countries</option>
                        {% for country in countries %}
                        <option value="{{ country }}" {% if current_country == country %}selected{% endif %}>{{ country }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Clear Filters #}
                {% if current_country or current_state or current_search %}
                <div class="filter-section">
                    <a href="{{ page.url }}" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-x-circle me-1"></i>Clear All Filters
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {# Results #}
        <div class="col-12 col-lg-9">
            {# Results Header #}
            <div class="results-header mb-3">
                <span class="results-count">
                    <strong>{{ total_count }}</strong> researcher{{ total_count|pluralize }}
                    {% if current_state %}in {{ current_state }}{% endif %}
                    {% if current_country and not current_state %}in {{ current_country }}{% endif %}
                    {% if current_search %}matching "{{ current_search }}"{% endif %}
                </span>
            </div>

            {# Researcher Cards - Compact Grid #}
            {% if researchers %}
            <div class="researcher-grid">
                {% for researcher in researchers %}
                <div class="researcher-card">
                    {% if researcher.website_url or researcher.orcid_id or researcher.pubmed_url or researcher.google_scholar_url %}
                    {# Name with dropdown if links exist #}
                    <div class="dropdown">
                        <button class="researcher-name-btn dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            {{ researcher.full_name }}
                        </button>
                        <ul class="dropdown-menu researcher-dropdown">
                            {% if researcher.website_url %}
                            <li>
                                <a class="dropdown-item" href="{{ researcher.website_url }}" target="_blank" rel="noopener">
                                    <i class="bi bi-globe me-2"></i>Website
                                </a>
                            </li>
                            {% endif %}
                            {% if researcher.orcid_id %}
                            <li>
                                <a class="dropdown-item" href="{{ researcher.orcid_url }}" target="_blank" rel="noopener">
                                    <i class="bi bi-person-badge me-2 text-orcid"></i>ORCID
                                </a>
                            </li>
                            {% endif %}
                            {% if researcher.pubmed_url %}
                            <li>
                                <a class="dropdown-item" href="{{ researcher.pubmed_url }}" target="_blank" rel="noopener">
                                    <i class="bi bi-journal-text me-2 text-pubmed"></i>PubMed
                                </a>
                            </li>
                            {% endif %}
                            {% if researcher.google_scholar_url %}
                            <li>
                                <a class="dropdown-item" href="{{ researcher.google_scholar_url }}" target="_blank" rel="noopener">
                                    <i class="bi bi-mortarboard me-2 text-scholar"></i>Google Scholar
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% else %}
                    {# Plain name if no links #}
                    <h5 class="researcher-name">{{ researcher.full_name }}</h5>
                    {% endif %}
                    <div class="researcher-institution">{{ researcher.institution }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No researchers found matching your criteria. Try adjusting your filters.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    const countryFilter = document.getElementById('countryFilter');

    // Country dropdown change
    countryFilter.addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);

        // Clear state when changing country (state buttons handle USA states)
        params.delete('state');

        if (this.value) {
            params.set('country', this.value);
        } else {
            params.delete('country');
        }

        window.location.href = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    });
})();
</script>
{% endblock %}
